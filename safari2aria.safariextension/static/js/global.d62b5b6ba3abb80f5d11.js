webpackJsonp([4],{213:function(e,n,t){"use strict";function o(){var e={};E.rpcList.forEach(function(n,t){var o=n.url.match(/^(http|ws)(s)?(?:\:\/\/)(token\:[^@]*)?@?([^\:\/]*)\:?(\d*)(\/[^\/]*)/),a={host:o[4],port:o[5]||6800,secure:!(!o||!o[2]),secret:o[3]?o[3].split(":")[1]:"",path:o[6]||"/jsonrpc"};if(j[n.url])e[n.url]=j[n.url],delete j[n.url];else{var r=new D.Aria2(a);e[n.url]={aria2:r,rpc:n,push:n.push}}n.push&&i(e[n.url],n.name)});for(var n in j){var t=j[n].aria2;t&&t.socket&&1===t.socket.readyState&&j[n].aria2.close()}j=e}function i(e,n){var t=e.aria2;return!(!e.aria2||!e.aria2.socket||1!==t.socket.readyState)||(t.open().then(function(){r(e,n),e.reconnect&&(delete e.reconnect,B.success(["成功链接",n]))}).catch(function(t){I()(safari,"application.activeBrowserWindow.activeTab.url")&&(!e.reconnect&&B.error(["请确认aria2已经运行,每隔10秒将会自动重试"],[n,"连接失败"]),e.reconnect=!0),T=T||setInterval(function(){var e=0;C()(j,function(n){e+=i(n)?0:1}),e||clearInterval(T)},1e4)}),!1)}function a(){I()(safari,"extension.popovers[0].contentWindow.tlwin.refreshTaskList")&&safari.extension.popovers[0].contentWindow.tlwin.refreshTaskList()}function r(e,n){var t=e.aria2,o=function(e){a()},i=function(e){a()},r=function(e,n){a(),s(t,e.gid).then(function(e){B.show(n?"error":"success",[e,"下载",n?"失败":"成功"])})};t.onDownloadStart=o,t.onDownloadPause=i,t.onDownloadStop=i,t.onDownloadComplete=r,t.onBtDownloadComplete=r,t.onDownloadError=function(e){r(e,!0)}}function s(e,n){return e.tellStatus(n,["bittorrent"]).then(function(t){return e.getFiles(n).then(function(e){return{files:e,bt:t}})}).then(function(e){var n=e.files[0].path,t=n.split("/").pop();return e.bt&&e.bt.info?bt.bittorrent.info.name:t}).catch(function(e){B.error(["获取任务信息失败"])})}function c(e){var n=j[e[0].url],t=!!n&&n.aria2,o=E.enableCookie?"Cookie: "+e[3]:"";t&&e[1]?t.addUri([e[1]],{header:o,timeout:10,"content-disposition-default-utf8":!0,"user-agent":E.userAgent}).then(function(){B.success(["成功添加至",n.rpc.name,E.enableCookie?"":"(关闭cookie)"])}).catch(function(e){B.error(["添加至",n.rpc.name,"失败",E.enableCookie?"":"(关闭cookie)"]),console.log(e)}):B.error(["添加任务失败：没有url或者没有连接aria2"])}function l(e){"showOptions"===e.key&&u()}function u(){safari.application.activeBrowserWindow.openTab().url=safari.extension.baseURI+"options.html"}function f(){E=localStorage.getItem("safari2aria");try{E=JSON.parse(E||"{}")}catch(e){E={defaultRpcIndex:0}}W=E.filetypes?E.filetypes.split(" "):[];for(var e=0;e<W.length;e++)W[e]=W[e].toLowerCase();P=E.rpcList,p("sendToEndScript",E),o(),I()(safari,"extension.popovers[0].contentWindow.tlwin.refreshServerList")&&safari.extension.popovers[0].contentWindow.tlwin.refreshServerList()}function p(e,n,t){n instanceof Function&&(t=n,n={}),t&&(n=x()(n||{},{hasCb:!0}),M[e+"_cb"]=t),window.safari&&safari.application.activeBrowserWindow.activeTab.page&&safari.application.activeBrowserWindow.activeTab.page.dispatchMessage(e,n)}function d(e){if(O=e.keyPressed||{},O.isShiftPressd&&O.isOptionPressd){for(var n=49;n<=57&&n-49<P.length;n++)if(O[n]){E.defaultRpcIndex=n-49,g({name:"updateSafari2Aria",message:E}),p("changeRpc",P[E.defaultRpcIndex].name);break}O[192]&&p("currentRpc",P[E.defaultRpcIndex].name),O[188]&&u(),O[76]&&safari&&safari.extension&&safari.extension.toolbarItems[0].showPopover()}}function h(e){var n=e.command.split("."),t={showOptions:function(){u()},DownloadWithXunleilixian:function(){safari.application.activeBrowserWindow.openTab().url=["http://lixian.vip.xunlei.com/?furl=",e.userInfo[0]].join("")},DownloadWithBaidulixian:function(){safari.application.activeBrowserWindow.openTab().url="https://pan.baidu.com/disk/home",R.baiduLixian={action:function(){p("baiduLixian",this.param),delete R.baiduLixian},param:{url:e.userInfo[0]}}},DownloadWithAria2:function(){var t=n[1];c([t&&P[t]?P[t]:P[0]].concat(e.userInfo))}};t[n[0]]&&t[n[0]]()}function m(e){var n=e.command&&e.command.match(/^DownloadWith/);if(n&&n.length>=0){var t=e.userInfo;t&&t.length&&t[0]||(e.target.disabled=!0)}}function v(e){t.i(L.a)(e.url,E,O)&&(e.preventDefault(),p("getCookie",function(n){c([P[E.defaultRpcIndex],e.url,e.target.url,n.cookie])}))}function w(e){P.forEach(function(n,t){e.contextMenu.appendContextMenuItem(["DownloadWithAria2",t].join("."),["下载至",n.name].join(""))}),E.enableXunleiLixian&&e.contextMenu.appendContextMenuItem("DownloadWithXunleilixian",["导入至迅雷离线"].join("")),E.enableBaiduLixian&&e.contextMenu.appendContextMenuItem("DownloadWithBaidulixian",["导入至百度离线"].join(""))}function g(e){M[e.name]&&M[e.name](e.message,e)}Object.defineProperty(n,"__esModule",{value:!0});var y=t(31),x=t.n(y),b=t(53),k=t.n(b),S=t(54),I=t.n(S),A=t(82),C=t.n(A),D=t(81),L=t(55),E={defaultRpcIndex:0},O=void 0,W=[],P=[],j={},R={},T=void 0,M={updateSafari2Aria:function(e){localStorage.setItem("safari2aria",k()(e)),f()},keyPress:function(e){d(e)},getConfig:function(){p("sendToEndScript",E)},documentReady:function(){C()(R,function(e){e.action()})},downloadFromIframe:function(e,n){c([P[E.defaultRpcIndex],e.url,n.target.url,e.cookie])}},B={success:function(e,n){B.show("success",e,n)},error:function(e,n){B.show("error",e,n)},show:function(e,n,t){n instanceof Array&&(n=n.join("")),t instanceof Array&&(t=t.join("")),p("showMassage",{action:e||"success",text:n,title:t})}};window.s2a={changeServer:function(e){var n=void 0;C()(P,function(t,o){t.url===e&&(n=o)}),E.defaultRpcIndex=n,g({name:"updateSafari2Aria",message:E})},openOptions:u,getConfig:function(){return{config:E,aria2Connects:j}}},document.addEventListener("DOMContentLoaded",f),safari.application.addEventListener("message",g,!1),safari.extension.settings.addEventListener("change",l,!1),safari.application.addEventListener("command",h,!1),safari.application.addEventListener("validate",m,!1),safari.application.addEventListener("beforeNavigate",v,!1),safari.application.addEventListener("contextmenu",w,!1)},55:function(e,n,t){"use strict";function o(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(e&&!t[82]&&n.enableTypefiles?!t.isCommandPressed:t.isCommandPressed){if(e.match(/magnet:[^\\"]+/))return!0;var o=e.substr(e.lastIndexOf(".")+1);o=o.toLowerCase();for(var i=n.filetypes?n.filetypes.split(" "):[],a=0;a<i.length;a++)if(o===i[a].toLowerCase()||t.isShiftPressd)return!0}}n.a=o},81:function(e,n,t){"use strict";(function(e){var n=t(53),o=t.n(n),i=t(33),a=t.n(i),r=t(151),s=t.n(r),c=t(183),l=t.n(c);!function(n){var t=void 0!==e&&e.exports,i=function e(n){this.callbacks=s()(null),this.lastId=0;for(var t in e.options)this[t]="object"===(void 0===n?"undefined":a()(n))&&t in n?n[t]:e.options[t]};i.prototype.http=function(e,n){var t=this,i={method:e.method,id:e.id};Array.isArray(e.params)&&e.params.length>0&&(i.params=e.params);var a="http"+(this.secure?"s":"")+"://"+this.host+":"+this.port+this.path;fetch(a,{method:"POST",body:o()(i),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){t._onmessage(e)}).catch(n)},i.prototype.send=function(e){var n=Array.prototype.slice.call(arguments,1),t="function"==typeof n[n.length-1]?n.pop():null;return this.exec(e,n,t)},i.prototype.exec=function(e,n,t){if("string"!=typeof e)throw new TypeError(e+" is not a string");0!==e.indexOf("system.")&&0!==e.indexOf("aria2.")&&(e="aria2."+e);var i={method:e,"json-rpc":"2.0",id:this.lastId++},a=this.secret?["token:"+this.secret]:[];Array.isArray(n)&&("system.multicall"===e?(Array.isArray(n[0])&&n[0].forEach(function(e){e.params||(e.params=[]),e.params=a.concat(e.params)}),a=n):a=a.concat(n)),a.length>0&&(i.params=a),this.onsend(i);var r=this;return this.socket&&1===this.socket.readyState?this.socket.send(o()(i)):this.http(i,function(e){r.callbacks[i.id](e),delete r.callbacks[i.id]}),l()(function(e){r.callbacks[i.id]=e},t)},i.prototype._onmessage=function(e){if(this.onmessage(e),void 0!==e.id){var n=this.callbacks[e.id];n&&(e.error?n(e.error):n(null,e.result),delete this.callbacks[e.id])}else if(e.method){var t=e.method.split("aria2.")[1];0===t.indexOf("on")&&"function"==typeof this[t]&&i.notifications.indexOf(t)>-1&&this[t].apply(this,e.params)}},i.prototype.open=function(e){var n="ws"+(this.secure?"s":"")+"://"+this.host+":"+this.port+this.path,t=this.socket=new WebSocket(n),o=this,i=!1;return t.onmessage=function(e){o._onmessage(JSON.parse(e.data))},l()(function(e){t.onopen=function(){i||(e(),i=!0),o.onopen()},t.onclose=function(n){o.onclose(),1006==n.code&&(i||(e(n),i=!0))},t.onerror=function(n){i||(e(n),i=!0)}},e)},i.prototype.close=function(e){var n=this.socket;return l()(function(e){n?(n.addEventListener("close",function(){e()}),n.close()):e()},e)},i.methods=["addUri","addTorrent","addMetalink","remove","forceRemove","pause","pauseAll","forcePause","forcePauseAll","unpause","unpauseAll","tellStatus","getUris","getFiles","getPeers","getServers","tellActive","tellWaiting","tellStopped","changePosition","changeUri","getOption","changeOption","getGlobalOption","changeGlobalOption","getGlobalStat","purgeDownloadResult","removeDownloadResult","getVersion","getSessionInfo","shutdown","forceShutdown","saveSession","system.multicall","system.listMethods","system.listNotifications"],i.notifications=["onDownloadStart","onDownloadPause","onDownloadStop","onDownloadComplete","onDownloadError","onBtDownloadComplete"],i.events=["onopen","onclose","onsend","onmessage"],i.options={secure:!1,host:"localhost",port:6800,secret:"",path:"/jsonrpc"},i.methods.forEach(function(e){var n=e.indexOf(".")>-1?e.split(".")[1]:e;i.prototype[n]=function(){return this.send.apply(this,[e].concat(Array.prototype.slice.call(arguments)))}}),i.notifications.forEach(function(e){i.prototype[e]=function(){}}),i.events.forEach(function(e){i.prototype[e]=function(){}}),t?e.exports=i:n.Aria2=i}(this)}).call(n,t(188)(e))}},[213]);